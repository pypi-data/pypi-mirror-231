# PIPELINE DEFINITION
# Name: upload-pytorch-model
# Inputs:
#    custom_container: bool [Default: False]
#    custom_tokenizer_name: str
#    custom_tokenizer_path: str
#    extra_files_staging_path: str
#    extra_files_to_ignore: list [Default: []]
#    extra_prediction_files: str
#    gcs_model_path: system.Artifact
#    handler: str
#    health_route: str [Default: '/ping']
#    is_default_version: bool [Default: True]
#    local_model_file: str
#    location: str
#    model_description: str
#    model_display_name: str
#    model_name: str [Default: 'model']
#    parent_model: str
#    predict_route: str [Default: '/predictions/model']
#    project_id: str
#    requirements: str
#    serving_container_args: list
#    serving_container_command: list
#    serving_container_image_uri: str [Default: 'europe-docker.pkg.dev/vertex-ai/prediction/pytorch-cpu.1-12:latest']
#    serving_container_ports: list [Default: [8080.0]]
#    serving_environment_vars: dict [Default: {'MODEL_NAME': 'model'}]
#    version: str [Default: 'v1.0']
#    version_description: str
# Outputs:
#    vertex_model: system.Model
components:
  comp-upload-pytorch-model:
    executorLabel: exec-upload-pytorch-model
    inputDefinitions:
      artifacts:
        gcs_model_path:
          artifactType:
            schemaTitle: system.Artifact
            schemaVersion: 0.0.1
          description: Artifact - KFP artifact that includes the path to the model
            artifact in the uri
      parameters:
        custom_container:
          defaultValue: false
          description: 'bool - Whether to use a custom container or the pre-built
            container.

            If using a custom, the arguments below will be used'
          isOptional: true
          parameterType: BOOLEAN
        custom_tokenizer_name:
          description: 'str - Name of custom tokenizer. Leave blank if your model
            uses

            a default tokenizer'
          isOptional: true
          parameterType: STRING
        custom_tokenizer_path:
          description: 'str - Path to GCS file where the custom tokenizer is located.

            Leave blank if your model uses a default tokenizer'
          isOptional: true
          parameterType: STRING
        extra_files_staging_path:
          description: 'str - Path to GCS folder that contains additional files that
            must

            be included in the .mar package'
          isOptional: true
          parameterType: STRING
        extra_files_to_ignore:
          defaultValue: []
          description: 'list - List of files included in the GCS model folder that
            you don''t

            wish to include in the .mar package'
          isOptional: true
          parameterType: LIST
        extra_prediction_files:
          description: 'str - Name of additional files that must be included in the
            .mar

            package for serving predictions'
          isOptional: true
          parameterType: STRING
        handler:
          description: 'str - Name of custom handler file used for serving. If using
            the default

            TorchServe one provide its name'
          parameterType: STRING
        health_route:
          defaultValue: /ping
          description: 'str - Overwrites the default health route in the serving container.

            Must be set to "/ping". Only used is custom_container=True'
          isOptional: true
          parameterType: STRING
        is_default_version:
          defaultValue: true
          description: 'bool - When set to True, the newly uploaded model version
            will

            automatically have alias "default" included. Subsequent uses of this model
            without

            a version specified will use this "default" version. When set to False,
            the "default"

            alias will not be moved. Actions targeting the newly-uploaded model version
            will

            need to specifically reference this version by ID or alias. New model
            uploads,

            i.e. version 1, will always be "default" aliased.,'
          isOptional: true
          parameterType: BOOLEAN
        local_model_file:
          description: 'str - File name of the model artifact (ie: pytorch_model.bin)'
          parameterType: STRING
        location:
          description: str - GCP location
          parameterType: STRING
        model_description:
          description: str - Model description used in the Model Registry
          isOptional: true
          parameterType: STRING
        model_display_name:
          description: str - Display name for Vertex Model in the Model Registry
          parameterType: STRING
        model_name:
          defaultValue: model
          description: str - Model name used for TorchServe (recommended to leave
            as default 'model')
          isOptional: true
          parameterType: STRING
        parent_model:
          description: 'str - The resource name or model ID of an existing model that
            the

            newly-uploaded model will be a version of. Only set this field when uploading
            a

            new version of an existing model.'
          isOptional: true
          parameterType: STRING
        predict_route:
          defaultValue: /predictions/model
          description: 'str - Overwrites the default prediction route in the serving
            container.

            Must be set to "/predictions/model"". Only used is custom_container=True'
          isOptional: true
          parameterType: STRING
        project_id:
          description: str - GCP project ID
          parameterType: STRING
        requirements:
          description: str - Additional packages required by the model for serving
            predictions
          isOptional: true
          parameterType: STRING
        serving_container_args:
          description: 'list - Overwrites the CMD of the Vertex pre-built container.

            Only used is custom_container=False'
          isOptional: true
          parameterType: LIST
        serving_container_command:
          description: 'list - Overwrites the ENTRYPOINT of the Vertex pre-built container.

            Only used is custom_container=False'
          isOptional: true
          parameterType: LIST
        serving_container_image_uri:
          defaultValue: europe-docker.pkg.dev/vertex-ai/prediction/pytorch-cpu.1-12:latest
          description: 'str - Path to container image used for serving.

            Uses the pre-built Vertex container by default'
          isOptional: true
          parameterType: STRING
        serving_container_ports:
          defaultValue:
          - 8080.0
          description: 'list - Overwrites the default ports in the serving container.

            Only used is custom_container=True'
          isOptional: true
          parameterType: LIST
        serving_environment_vars:
          defaultValue:
            MODEL_NAME: model
          description: 'dict - Overwrites the default environment variables in the
            serving container.

            Only used is custom_container=True'
          isOptional: true
          parameterType: STRUCT
        version:
          defaultValue: v1.0
          description: str - Model version used for TorchServe (recommended to leave
            as default 'v1.0')
          isOptional: true
          parameterType: STRING
        version_description:
          description: str - The description of the model version being uploaded.,
          isOptional: true
          parameterType: STRING
    outputDefinitions:
      artifacts:
        vertex_model:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
          description: 'Model - Vertex model in Model Registry. Metadata includes:

            DisplayName - Display name shown in Vertex Model Registry

            VertexModelID - Full path to Vertex Model Registry ID (<project>/<location>/model/ID)'
deploymentSpec:
  executors:
    exec-upload-pytorch-model:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - upload_pytorch_model
        command:
        - python3
        - -m
        - kfp.components.executor_main
        image: dtpipelinecomponents/upload_pytorch_model:v1.1.1
pipelineInfo:
  name: upload-pytorch-model
root:
  dag:
    outputs:
      artifacts:
        vertex_model:
          artifactSelectors:
          - outputArtifactKey: vertex_model
            producerSubtask: upload-pytorch-model
    tasks:
      upload-pytorch-model:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-upload-pytorch-model
        inputs:
          artifacts:
            gcs_model_path:
              componentInputArtifact: gcs_model_path
          parameters:
            custom_container:
              componentInputParameter: custom_container
            custom_tokenizer_name:
              componentInputParameter: custom_tokenizer_name
            custom_tokenizer_path:
              componentInputParameter: custom_tokenizer_path
            extra_files_staging_path:
              componentInputParameter: extra_files_staging_path
            extra_files_to_ignore:
              componentInputParameter: extra_files_to_ignore
            extra_prediction_files:
              componentInputParameter: extra_prediction_files
            handler:
              componentInputParameter: handler
            health_route:
              componentInputParameter: health_route
            is_default_version:
              componentInputParameter: is_default_version
            local_model_file:
              componentInputParameter: local_model_file
            location:
              componentInputParameter: location
            model_description:
              componentInputParameter: model_description
            model_display_name:
              componentInputParameter: model_display_name
            model_name:
              componentInputParameter: model_name
            parent_model:
              componentInputParameter: parent_model
            predict_route:
              componentInputParameter: predict_route
            project_id:
              componentInputParameter: project_id
            requirements:
              componentInputParameter: requirements
            serving_container_args:
              componentInputParameter: serving_container_args
            serving_container_command:
              componentInputParameter: serving_container_command
            serving_container_image_uri:
              componentInputParameter: serving_container_image_uri
            serving_container_ports:
              componentInputParameter: serving_container_ports
            serving_environment_vars:
              componentInputParameter: serving_environment_vars
            version:
              componentInputParameter: version
            version_description:
              componentInputParameter: version_description
        taskInfo:
          name: upload-pytorch-model
  inputDefinitions:
    artifacts:
      gcs_model_path:
        artifactType:
          schemaTitle: system.Artifact
          schemaVersion: 0.0.1
        description: Artifact - KFP artifact that includes the path to the model artifact
          in the uri
    parameters:
      custom_container:
        defaultValue: false
        description: 'bool - Whether to use a custom container or the pre-built container.

          If using a custom, the arguments below will be used'
        isOptional: true
        parameterType: BOOLEAN
      custom_tokenizer_name:
        description: 'str - Name of custom tokenizer. Leave blank if your model uses

          a default tokenizer'
        isOptional: true
        parameterType: STRING
      custom_tokenizer_path:
        description: 'str - Path to GCS file where the custom tokenizer is located.

          Leave blank if your model uses a default tokenizer'
        isOptional: true
        parameterType: STRING
      extra_files_staging_path:
        description: 'str - Path to GCS folder that contains additional files that
          must

          be included in the .mar package'
        isOptional: true
        parameterType: STRING
      extra_files_to_ignore:
        defaultValue: []
        description: 'list - List of files included in the GCS model folder that you
          don''t

          wish to include in the .mar package'
        isOptional: true
        parameterType: LIST
      extra_prediction_files:
        description: 'str - Name of additional files that must be included in the
          .mar

          package for serving predictions'
        isOptional: true
        parameterType: STRING
      handler:
        description: 'str - Name of custom handler file used for serving. If using
          the default

          TorchServe one provide its name'
        parameterType: STRING
      health_route:
        defaultValue: /ping
        description: 'str - Overwrites the default health route in the serving container.

          Must be set to "/ping". Only used is custom_container=True'
        isOptional: true
        parameterType: STRING
      is_default_version:
        defaultValue: true
        description: 'bool - When set to True, the newly uploaded model version will

          automatically have alias "default" included. Subsequent uses of this model
          without

          a version specified will use this "default" version. When set to False,
          the "default"

          alias will not be moved. Actions targeting the newly-uploaded model version
          will

          need to specifically reference this version by ID or alias. New model uploads,

          i.e. version 1, will always be "default" aliased.,'
        isOptional: true
        parameterType: BOOLEAN
      local_model_file:
        description: 'str - File name of the model artifact (ie: pytorch_model.bin)'
        parameterType: STRING
      location:
        description: str - GCP location
        parameterType: STRING
      model_description:
        description: str - Model description used in the Model Registry
        isOptional: true
        parameterType: STRING
      model_display_name:
        description: str - Display name for Vertex Model in the Model Registry
        parameterType: STRING
      model_name:
        defaultValue: model
        description: str - Model name used for TorchServe (recommended to leave as
          default 'model')
        isOptional: true
        parameterType: STRING
      parent_model:
        description: 'str - The resource name or model ID of an existing model that
          the

          newly-uploaded model will be a version of. Only set this field when uploading
          a

          new version of an existing model.'
        isOptional: true
        parameterType: STRING
      predict_route:
        defaultValue: /predictions/model
        description: 'str - Overwrites the default prediction route in the serving
          container.

          Must be set to "/predictions/model"". Only used is custom_container=True'
        isOptional: true
        parameterType: STRING
      project_id:
        description: str - GCP project ID
        parameterType: STRING
      requirements:
        description: str - Additional packages required by the model for serving predictions
        isOptional: true
        parameterType: STRING
      serving_container_args:
        description: 'list - Overwrites the CMD of the Vertex pre-built container.

          Only used is custom_container=False'
        isOptional: true
        parameterType: LIST
      serving_container_command:
        description: 'list - Overwrites the ENTRYPOINT of the Vertex pre-built container.

          Only used is custom_container=False'
        isOptional: true
        parameterType: LIST
      serving_container_image_uri:
        defaultValue: europe-docker.pkg.dev/vertex-ai/prediction/pytorch-cpu.1-12:latest
        description: 'str - Path to container image used for serving.

          Uses the pre-built Vertex container by default'
        isOptional: true
        parameterType: STRING
      serving_container_ports:
        defaultValue:
        - 8080.0
        description: 'list - Overwrites the default ports in the serving container.

          Only used is custom_container=True'
        isOptional: true
        parameterType: LIST
      serving_environment_vars:
        defaultValue:
          MODEL_NAME: model
        description: 'dict - Overwrites the default environment variables in the serving
          container.

          Only used is custom_container=True'
        isOptional: true
        parameterType: STRUCT
      version:
        defaultValue: v1.0
        description: str - Model version used for TorchServe (recommended to leave
          as default 'v1.0')
        isOptional: true
        parameterType: STRING
      version_description:
        description: str - The description of the model version being uploaded.,
        isOptional: true
        parameterType: STRING
  outputDefinitions:
    artifacts:
      vertex_model:
        artifactType:
          schemaTitle: system.Model
          schemaVersion: 0.0.1
        description: 'Model - Vertex model in Model Registry. Metadata includes:

          DisplayName - Display name shown in Vertex Model Registry

          VertexModelID - Full path to Vertex Model Registry ID (<project>/<location>/model/ID)'
schemaVersion: 2.1.0
sdkVersion: kfp-2.0.1
